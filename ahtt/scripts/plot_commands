# Plot commands for all plots in the PAS/Paper
# All to be executed in a python 3 environment, ideally with reasonably new matplotlib & mplhep versions
# (for me its LCG104 + a virtual env with mplhep and matplotlib updated)
# for lcg: source /cvmfs/sft.cern.ch/lcg/views/setupViews.sh LCG_104 x86_64-el9-gcc11-opt
# EXCEPTION: impact plot, that needs EL7 container + CMSSW

#PRE/POST

etatdir='/nfs/dust/cms/user/afiqaize/cms/ahtt_run2ul_stat_200803/combine/CMSSW_10_2_13/src/CombineHarvester/ahtt/ah_thrcompat_240530/A_m365_w2p0__H_m365_w2p0_mitetat'
ahdir='/nfs/dust/cms/user/afiqaize/cms/ahtt_run2ul_stat_200803/combine/CMSSW_10_2_13/src/CombineHarvester/ahtt/ah_thrcompat_240530/A_m365_w2p0__H_m365_w2p0_lx'

outdir="." # change if needed
fmt="pdf,png,svg"
mkdir -p outdir

# combined plots
for channel in ll l4pj l3j; do
    python3 ../scripts/plot_prepost_combined.py --odir $outdir --ifile ${etatdir}/A_*__*_fitdiagnostics_result_CMS_EtaT_norm_13TeV_g1_0p0_g2_0p0_fixed_s.root --ifileah ${ahdir}/A_*__H_*_fitdiagnostics_result_s.root --plot-format ${fmt} --log --batch ${etatdir}/A_*__H_*_psfromws_${channel}_all_CMS_EtaT_norm_13TeV_g1_0p0_g2_0p0_fixed_s.root --batchah ${ahdir}/A_*__H_*_psfromws_${channel}_all_s.root --prefit-signal-from default --preliminary
done

# prefit only

python3 ../scripts/plot_prepost.py --odir ${outdir} --ifile ${etatdir}/A_*__H_*_fitdiagnostics_result_CMS_EtaT_norm_13TeV_g1_0p0_g2_0p0_fixed_s.root --plot-format ${fmt} --log --skip-each --batch yes --skip-postfit --prefit-signal-from default --as-signal 'A,H,EtaT' --preliminary


# separate postfits

for channel in ll l4pj l3j; do
    # A/H postfit
    python3 ../scripts/plot_prepost.py --odir ${outdir} --ifile ${ahdir}/A_*__H_*_fitdiagnostics_result_s.root --plot-format ${fmt} --log --skip-each --batch ${ahdir}/A_*__H_*_psfromws_${channel}_all_s.root --skip-prefit --preliminary

    # BG only postfit
    python3 ../scripts/plot_prepost.py --odir ${outdir} --ifile ${ahdir}/A_*__H_*_fitdiagnostics_result_b.root --plot-format ${fmt} --log --skip-each --batch ${ahdir}/A_*__H_*_psfromws_${channel}_all_b.root --skip-prefit --preliminary

    # EtaT postfit
    python3 ../scripts/plot_prepost.py --odir ${outdir} --ifile ${etatdir}/A_*__*_fitdiagnostics_result_CMS_EtaT_norm_13TeV_g1_0p0_g2_0p0_fixed_s.root --plot-format ${fmt} --log --skip-each --batch ${etatdir}/A_*__H_*_psfromws_${channel}_all_CMS_EtaT_norm_13TeV_g1_0p0_g2_0p0_fixed_s.root --skip-prefit --as-signal 'EtaT' --skip-ah --preliminary
done


# LIMITS

# these are a bit stupid because they need to be executed in the actual directory where the limits are
# ... to which you do not have writing permissions if you are not Afiq
# thus, absolute paths

basedir="/nfs/dust/cms/user/lauridsj/ah/CMSSW_10_2_13/src/CombineHarvester/ahtt" # or whatever your dir is

# limits without etat
outdir="${basedir}/limits_smtt"  # also absolute path
mkdir -p outdir
fmt="pdf,png,svg"

cd /nfs/dust/cms/user/afiqaize/cms/ahtt_run2ul_stat_200803/combine/CMSSW_10_2_13/src/CombineHarvester/ahtt/cleanup_1D_240205
python3 ${basedir}/scripts/plot_limit.py --tag "lx_smtt" --odir ${outdir} --observed --formal --cms-append 'Preliminary' --A343-background 0 --plot-format ${fmt}

# limits with etat
outdir="${basedir}/limits_etat"  # also absolute path
mkdir -p outdir

cd /nfs/dust/cms/user/afiqaize/cms/ahtt_run2ul_stat_200803/combine/CMSSW_10_2_13/src/CombineHarvester/ahtt/ah_etatfloat_240318
python3 ${basedir}/scripts/plot_limit.py --tag "lx" --odir  ${outdir} --observed --formal --cms-append 'Preliminary' --A343-background 1 --plot-format ${fmt}

# CONTOURS

outdir="." # change if needed
fmt="pdf,png,svg"
mkdir -p outdir

# I think there is a syntax so you dont have to give all contours by hand, Afiq probably knows
pairs='A_m1000_w5p0,H_m365_w2p0;A_m365_w2p0,H_m1000_w5p0;A_m365_w2p0,H_m365_w2p0;A_m1000_w5p0,H_m1000_w5p0' 
python3 ../scripts/plot_contour.py --point "$pairs" --contour 'lx_etat/exp-b,obs' --odir ${outdir} --label 'Expected (b);Observed' --formal --A343-background 1 --draw-best-fit --cms-append Preliminary --plot-format ${fmt}

# CORRELATION
# this needs both a fitdiagnostics output, and impacts for the sorting

infile="nfs/dust/cms/user/afiqaize/cms/ahtt_run2ul_stat_200803/combine/CMSSW_10_2_13/src/CombineHarvester/ahtt/ah_thrcompat_240530/A_m365_w2p0__H_m365_w2p0_mitetat/A_m365_w2p0__H_m365_w2p0_mitetat_fitdiagnostics_result_CMS_EtaT_norm_13TeV_g1_0p0_g2_0p0_fixed_s.root"
impacts="/nfs/dust/cms/user/lauridsj/ah/CMSSW_10_2_13/src/CombineHarvester/ahtt/workdir_arc/A_m400_w5p0_lx_etatfit/A_m400_w5p0_lx_etatfit_impacts_CMS_EtaT_norm_13TeV_g_0p0_fixed_all.json"

python3 ../scripts/plot_correlation.py --infile ${infile} --outfile correlation_etat.pdf --signal EtaT --only 21 --nuisance_map ../scripts/nuisance_map.json --impacts ${impacts} --preliminary

# IMPACTS
# these need a different environment than the rest, namely an EL7 container
# fresh shell required

cmssw-el7 --interactive --contain --bind /afs:/afs --bind /cvmfs:/cvmfs --bind /pnfs:/pnfs --bind /nfs:/nfs --bind /tmp:/host/tmp --home $HOME --pwd `pwd -P`
cd /wherever/your/workdir/is/CMSSW_10_2_13/src
cmsenv
cd CombineHarvester/ahtt

infile_data="/nfs/dust/cms/user/lauridsj/ah/CMSSW_10_2_13/src/CombineHarvester/ahtt/workdir_arc/A_m400_w5p0_lx_etatfit/A_m400_w5p0_lx_etatfit_impacts_CMS_EtaT_norm_13TeV_g_0p0_fixed_all.json"
infile_asimov="/nfs/dust/cms/user/lauridsj/ah/CMSSW_10_2_13/src/CombineHarvester/ahtt/workdir_arc/A_m400_w5p0_lx_etatfit_asimov/A_m400_w5p0_lx_etatfit_asimov_impacts_CMS_EtaT_norm_13TeV_g_0p0_fixed_all.json"

python scripts/customImpacts.py -i ${infile_data} -ia ${infile_asimov} -o impacts_etat_lx -t scripts/nuisance_map.json --per-page 20 --cms-label 'Preliminary'